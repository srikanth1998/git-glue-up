const E={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1};let $=0;function ie(n,c){const l=`atom${++$}`,d={toString(){return(E?"production":void 0)!=="production"&&this.debugLabel?l+":"+this.debugLabel:l}};return typeof n=="function"?d.read=n:(d.init=n,d.read=q,d.write=Q),c&&(d.write=c),d}function q(n){return n(this)}function Q(n,c,l){return c(this,typeof l=="function"?l(n(this)):l)}const x=(n,c)=>n.unstable_is?n.unstable_is(c):c===n,V=n=>"init"in n,U=n=>!!n.write,I=new WeakMap,F=n=>{var c;return J(n)&&!((c=I.get(n))!=null&&c[1])},Y=(n,c)=>{const l=I.get(n);if(l)l[1]=!0,l[0].forEach(d=>d(c));else if((E?"production":void 0)!=="production")throw new Error("[Bug] cancelable promise not found")},Z=n=>{if(I.has(n))return;const c=[new Set,!1];I.set(n,c);const l=()=>{c[1]=!0};n.then(l,l),n.onCancel=d=>{c[0].add(d)}},J=n=>typeof(n==null?void 0:n.then)=="function",G=n=>"v"in n||"e"in n,R=n=>{if("e"in n)throw n.e;if((E?"production":void 0)!=="production"&&!("v"in n))throw new Error("[Bug] atom state is not initialized");return n.v},K=(n,c,l)=>{l.p.has(n)||(l.p.add(n),c.then(()=>{l.p.delete(n)},()=>{l.p.delete(n)}))},ee=(n,c,l,d)=>{var _;if((E?"production":void 0)!=="production"&&l===n)throw new Error("[Bug] atom cannot depend on itself");c.d.set(l,d.n),F(c.v)&&K(n,c.v,d),(_=d.m)==null||_.t.add(n)},ne=Symbol.for("JOTAI.EXPERIMENTAL.FLUSHSTOREHOOK"),X=(...n)=>{const[c,l,d,_,T,N]=n,a=t=>{if((E?"production":void 0)!=="production"&&!t)throw new Error("Atom is undefined or null");let e=c(t);return e||(e={d:new Map,p:new Set,n:0},l(t,e),T==null||T(t,O)),e},w=new WeakMap,b=new Map,k=new Set,A=new Set,h=()=>{var t;const e=[],o=r=>{try{r()}catch(i){e.push(i)}};do{(t=O[ne])==null||t.call(O);const r=new Set,i=r.add.bind(r);b.forEach(s=>{var u;return(u=s.m)==null?void 0:u.l.forEach(i)}),b.clear(),k.forEach(i),k.clear(),A.forEach(i),A.clear(),r.forEach(o),b.size&&M()}while(b.size||k.size||A.size);if(e.length)throw e[0]},g=(t,e,o)=>{const r="v"in e,i=e.v,s=F(e.v)?e.v:null;if(J(o)){Z(o);for(const u of e.d.keys())K(t,o,a(u));e.v=o}else e.v=o;delete e.e,(!r||!Object.is(i,e.v))&&(++e.n,s&&Y(s,o))},y=t=>{var e;const o=a(t);if(G(o)&&(o.m&&w.get(t)!==o.n||Array.from(o.d).every(([f,m])=>y(f).n===m)))return o;o.d.clear();let r=!0;const i=()=>{o.m&&(W(t,o),M(),h())},s=f=>{if(x(t,f)){const z=a(f);if(!G(z))if(V(f))g(f,z,f.init);else throw new Error("no atom init");return R(z)}const m=y(f);try{return R(m)}finally{ee(t,o,f,m),r||i()}};let u,v;const p={get signal(){return u||(u=new AbortController),u.signal},get setSelf(){return(E?"production":void 0)!=="production"&&!U(t)&&console.warn("setSelf function cannot be used with read-only atom"),!v&&U(t)&&(v=(...f)=>{if((E?"production":void 0)!=="production"&&r&&console.warn("setSelf function cannot be called in sync"),!r)return H(t,...f)}),v}};try{const f=d(t,s,p);return g(t,o,f),J(f)&&((e=f.onCancel)==null||e.call(f,()=>u==null?void 0:u.abort()),f.then(i,i)),o}catch(f){return delete o.v,o.e=f,++o.n,o}finally{r=!1}},D=t=>R(y(t)),B=t=>{var e;const o=new Map;for(const r of((e=t.m)==null?void 0:e.t)||[]){const i=a(r);i.m&&o.set(r,i)}for(const r of t.p)o.set(r,a(r));return o},j=t=>{const e=[t];for(;e.length;){const o=e.pop();for(const[r,i]of B(o))w.has(r)||(w.set(r,i.n),e.push(i))}},M=()=>{var t;const e=[],o=new WeakSet,r=new WeakSet,i=Array.from(b);for(;i.length;){const[s,u]=i[i.length-1];if(r.has(s)){i.pop();continue}if(o.has(s)){w.get(s)===u.n?e.push([s,u,u.n]):(w.delete(s),b.set(s,u)),r.add(s),i.pop();continue}o.add(s);for(const[v,p]of B(u))o.has(v)||i.push([v,p])}for(let s=e.length-1;s>=0;--s){const[u,v,p]=e[s];let f=!1;for(const m of v.d.keys())if(m!==u&&b.has(m)){f=!0;break}f&&(y(u),W(u,v),p!==v.n&&(b.set(u,v),(t=v.u)==null||t.call(v))),w.delete(u)}},P=(t,...e)=>{let o=!0;const r=s=>R(y(s)),i=(s,...u)=>{var v;const p=a(s);try{if(x(t,s)){if(!V(s))throw new Error("atom not writable");const f=p.n,m=u[0];g(s,p,m),W(s,p),f!==p.n&&(b.set(s,p),(v=p.u)==null||v.call(p),j(p));return}else return P(s,...u)}finally{o||(M(),h())}};try{return _(t,r,i,...e)}finally{o=!1}},H=(t,...e)=>{try{return P(t,...e)}finally{M(),h()}},W=(t,e)=>{var o;if(e.m&&!F(e.v)){for(const[r,i]of e.d)if(!e.m.d.has(r)){const s=a(r);L(r,s).t.add(t),e.m.d.add(r),i!==s.n&&(b.set(r,s),(o=s.u)==null||o.call(s),j(s))}for(const r of e.m.d||[])if(!e.d.has(r)){e.m.d.delete(r);const i=C(r,a(r));i==null||i.t.delete(t)}}},L=(t,e)=>{var o;if(!e.m){y(t);for(const r of e.d.keys())L(r,a(r)).t.add(t);if(e.m={l:new Set,d:new Set(e.d.keys()),t:new Set},(o=e.h)==null||o.call(e),U(t)){const r=e.m,i=()=>{let s=!0;const u=(...v)=>{try{return P(t,...v)}finally{s||(M(),h())}};try{const v=N(t,u);v&&(r.u=()=>{s=!0;try{v()}finally{s=!1}})}finally{s=!1}};A.add(i)}}return e.m},C=(t,e)=>{var o;if(e.m&&!e.m.l.size&&!Array.from(e.m.t).some(r=>{var i;return(i=a(r).m)==null?void 0:i.d.has(t)})){const r=e.m.u;r&&k.add(r),delete e.m,(o=e.h)==null||o.call(e);for(const i of e.d.keys()){const s=C(i,a(i));s==null||s.t.delete(t)}return}return e.m},O={get:D,set:H,sub:(t,e)=>{const o=a(t),i=L(t,o).l;return i.add(e),h(),()=>{i.delete(e),C(t,o),h()}},unstable_derive:t=>X(...t(...n))};return O},te=n=>{const c=new Set;let l,d=0;const _=n.unstable_derive((...a)=>{const[w,b,,k]=a;return l=w,a[1]=function(h,g){b(h,g);const y=g.h;g.h=()=>{y==null||y(),g.m?c.add(h):c.delete(h)}},a[3]=function(h,g,y,...D){return d?y(h,...D):k(h,g,y,...D)},a}),T=_.set;return Object.assign(_,{dev4_get_internal_weak_map:()=>({get:a=>{const w=l(a);if(!(!w||w.n===0))return w}}),dev4_get_mounted_atoms:()=>c,dev4_restore_atoms:a=>{T({read:()=>null,write:(b,k)=>{++d;try{for(const[A,h]of a)V(A)&&k(A,h)}finally{--d}}})}})},oe=()=>{const n=new WeakMap,c=X(l=>n.get(l),(l,d)=>n.set(l,d).get(l),(l,...d)=>l.read(...d),(l,...d)=>l.write(...d),(l,...d)=>{var _;return(_=l.unstable_onInit)==null?void 0:_.call(l,...d)},(l,...d)=>{var _;return(_=l.onMount)==null?void 0:_.call(l,...d)});return(E?"production":void 0)!=="production"?te(c):c};let S;const le=()=>(S||(S=oe(),(E?"production":void 0)!=="production"&&(globalThis.__JOTAI_DEFAULT_STORE__||(globalThis.__JOTAI_DEFAULT_STORE__=S),globalThis.__JOTAI_DEFAULT_STORE__!==S&&console.warn("Detected multiple Jotai instances. It may cause unexpected behavior with the default store. https://github.com/pmndrs/jotai/discussions/2044"))),S);export{ie as a,oe as c,le as g};
